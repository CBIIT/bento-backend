
listeners:
  - Protocol: HTTP
    Port: 80
    DefaultActions:
      - Type: redirect
        RedirectConfig:
          Protocol: HTTPS
          Port: "443"
          Host: "#{host}"
          Path: "/#{path}"
          Query: "#{query}"
          StatusCode: "HTTP_301"
  - Protocol: HTTPS
    Port: 443
    DefaultActions:
      - Type: fixed-response
        FixedResponseConfig:
          ContentType: "text/plain"
          MessageBody: "This is the page you're looking for"
          StatusCode: "200"   
    Certificates:
      - CertificateArn: "{{certificate_arn}}"
    SslPolicy: "{{ssl_policy}}"
    Rules:
      - Conditions:
          - Field: host-header
            Values:
              - '{{tier}}.bento-tools.org'
          - Field: path-pattern
            Values:
              - "/*"
        Priority: '99'
        Actions:
          - TargetGroupName: bento-{{tier}}-frontend
            Type: forward

      - Conditions:
          - Field: host-header
            Values:
              - api-{{tier}}.bento-tools.org
          - Field: path-pattern
            Values:
              - "/*"
        Priority: '100'
        Actions:
          - TargetGroupName: bento-{{tier}}-backend
            Type: forward

      - Conditions:
          - Field: host-header
            Values:
              - icdc-sandbox.bento-tools.org
          - Field: path-pattern
            Values:
              - "/*"
        Priority: '101'
        Actions:
          - TargetGroupName: icdc-sandbox-web
            Type: forward

      - Conditions:
          - Field: host-header
            Values:
              - icdc-sandbox.bento-tools.org
          - Field: path-pattern
            Values:
              - "/v1/graphql/*"
        Priority: '102'
        Actions:
          - TargetGroupName: icdc-sandbox-backend
            Type: forward

        
        
      








- name: create application load balancer
  elb_application_lb:
    name: "{{ application_load_balancer.name }}"
    security_groups: "{{ alb_sg }}"
    subnets: "{{ subnet_id_list }}"
    listeners: "{{ application_load_balancer.listeners }}"
    deletion_protection: yes
    state: present


