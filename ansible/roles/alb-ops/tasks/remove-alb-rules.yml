---

- name: gather info about alb
  elb_application_lb_info:
    names: 
      - DEV-A-Appli-Caninedata-8UHLKJYN
    region: "{{region}}"
  register: alb_info

# - debug:
#     msg: >
#       "{{alb_info}}"
      
- name: set facts
  set_fact:
    alb_subnets: "{{ alb_info.load_balancers[0].availability_zones| json_query('[*].subnet_id')}}"
    alb_sg: "{{ alb_info.load_balancers[0].security_groups |list}}"
    alb_name: "{{ alb_info.load_balancers[0].load_balancer_name }}"
    certificate_arn: "{{alb_info.load_balancers[0].listeners[0].certificates[0].certificate_arn}}"


- debug:
    msg: >
      {{alb_sg}}
      {{alb_name}}
      {{certificate_arn}}
      {{alb_subnets}}

- name: modify application load balancer
  elb_application_lb: 
    name: "{{alb_name}}"
    security_groups: "{{ alb_sg }}"
    subnets: "{{ alb_subnets }}"
    listeners: "{{ add_listener }}"
    deletion_protection: yes
    region: '{{ region }}'
    purge_listeners: no
    purge_rules: no
    state: present


# - name: modify application load balancer
#   elb_application_lb: 
#     name: "{{alb_name}}"
#     security_groups: "{{ alb_sg }}"
#     subnets: "{{ alb_subnets }}"
#     listeners: "{{ listeners }}"
#     deletion_protection: yes
#     region: '{{ region }}'
#     # purge_listeners: no
#     # purge_rules: no
#     state: present

   

# - name: Creates a new set of listeners rules for the ALB
#   elb_application_lb:
#     name: '{{ alb_name }}'
#     state: present
#     region: '{{ region }}'
#     security_groups: '{{ alb_security_groups }}'
#     subnets: '{{ alb_subnets }}'
#     purge_listeners: '{{ should_purge_listeners }}'
#     deletion_protection: yes
#     listeners: '{{ listeners }}'
#   register: alb_with_new_listeners









# - debug:
#     msg: >
#      "{{ subnets}}"
#      "{{alb_sg}}"