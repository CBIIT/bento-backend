- name: touch previous_image.txt file
  file:
    path: "{{home}}/previous_image.txt"
    state: touch

- name: get info about frontend container
  docker_container_info:
    name: frontend
  register: frontend_details

- name: set jq
  set_fact:
    jq: container.Config.Env

- name: create /local/content/docker directory
  file:
    path: "{{home}}"
    state: directory

- name: check if backend tag exist
  stat:
    path: "{{home}}/backend_tag.txt"
  register: prev_backend

- name: check if prev_frontend tag exist
  stat:
    path: "{{home}}/frontend_tag"
  register: prev_frontend

- name: save frontend tag
  copy: 
    content: "{{frontend_details | json_query(jq) | select('match', 'REACT_APP_FE_VERSION')|list|first|replace('\"','')}}"
    dest: "{{home}}/frontend_tag.txt"
  when: not prev_frontend.stat.exists or release == "pass"

- name: save backend tag
  copy: 
    content: "{{frontend_details | json_query(jq) | select('match', 'REACT_APP_BE_VERSION')|list|first|replace('\"','')}}"
    dest: "{{home}}/backend_tag.txt"
  when: not prev_backend.stat.exists or release == "pass"

- name: save current deployed image
  shell: docker ps | grep nci* | awk '{print $2}'  > {{home}}/previous_image.txt
  when: not prev_frontend.stat.exists or release == "pass"