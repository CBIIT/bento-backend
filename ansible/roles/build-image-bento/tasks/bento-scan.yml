---
- name: backend image
  block:
    - name: get backend image vulnerabilities
      command: "trivy image {{ dockerhub_path }}/{{ project }}-backend:release"
      register: backend_vuln
  always:
    - name: echo backend vulnerabilities
      debug:
        msg: "{{ backend_vuln.stdout_lines }}"

- name: frontend image
  block:
    - name: get frontend image vulnerabilities
      command: "trivy image {{ dockerhub_path }}/{{ project }}-frontend:release"
      register: frontend_vuln
  always:
    - name: echo frontend vulnerabilities
      debug:
        msg: "{{ frontend_vuln.stdout_lines }}"

- name: test backend image
  command: "trivy image --exit-code 1 --severity HIGH,CRITICAL {{ dockerhub_path }}/{{ project }}-backend:release"

- name: test frontend image
  command: "trivy image --exit-code 1 --severity HIGH,CRITICAL {{ dockerhub_path }}/{{ project }}-frontend:release"