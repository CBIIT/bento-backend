---
# tasks file for cicd
# - name: copy application_example.properties to application.properties
#   copy:
#     remote_src: yes
#     src: "{{workspace}}/src/main/resources/application_example.properties"
#     dest: "{{workspace}}/src/main/resources/application.properties"

- name: remove the application_example.properties file 
  file:
    path: "{{workspace}}/src/main/resources/application_example.properties"
    state: absent

- name: copy application.properties file to /src/main/resources/
  template:
    src: application.properties.j2
    dest: "{{workspace}}/src/main/resources/application.properties"

- name: build springboot code
  command: mvn package -DskipTests
  args:
    chdir: "{{workspace}}"
- name: copy ICDC-0.0.1.war to ROOT.war
  copy:
    remote_src: yes
    src: "{{workspace}}/target/ICDC-0.0.1.war"
    dest: "{{workspace}}/target/ROOT.war"

- name: remove ICDC-0.0.1.war file 
  file:
    path: "{{workspace}}/target/ICDC-0.0.1.war"
    state: absent

- name: log into DockerHub
  docker_login:
    username: "{{docker_user}}"
    password: "{{docker_password}}"

- name: build cbiitssrepo/api repo
  docker_image:
    build:
      path: "{{workspace}}/target"
      dockerfile: "{{workspace}}/dockerfiles/backend-dockerfile"
    name: cbiitssrepo/api
    tag: "{{build_number}}"
    push: yes
    source: build

# - name: 
#           cd ${WORKSPACE}/src/main/frontend/
#           rm package-lock.json
#           yarn install --network-timeout 1000000
#           yarn build
#           docker build -t cbiitssrepo/app -f ${WORKSPACE}/dockerfiles/frontend-dockerfile .
#           docker push cbiitssrepo/app