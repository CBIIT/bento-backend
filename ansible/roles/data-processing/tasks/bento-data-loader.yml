---

- name: set model files location for icdc
  set_fact:
    model_file1: "{{workspace}}/icdc-model/model-desc/icdc-model.yml"
    model_file2: "{{workspace}}/icdc-model/model-desc/icdc-model-props.yml"
    property_file: "{{workspace}}/config/props-icdc-pmvp.yml"
  when: project == "icdc"

- name: set model files location for bento
  set_fact:
    model_file1: "{{workspace}}/bento-model/model-desc/bento_tailorx_model_file.yaml"
    model_file2: "{{workspace}}/bento-model/model-desc/bento_tailorx_model_properties.yaml"
    property_file: "{{workspace}}/config/props-bento-ext.yml"
  when: project == "bento"

- name: set model files location for ctdc
  set_fact:
    model_file1: "{{workspace}}/ctdc-model/model-desc/ctdc_model_file.yaml"
    model_file2: "{{workspace}}/ctdc-model/model-desc/ctdc_model_properties_file.yaml"
    property_file: "{{workspace}}/config/props-ctdc.yml"
  when: project == "ctdc"

- name: Check if tmp directory exist
  stat:
    path: "{{workspace}}/tmp"
  register: stat_result

- name: Check if tmp {{s3_folder}} exist
  stat:
    path: "{{workspace}}/{{s3_folder}}"
  register: s3folder_result

- name: remove the tmp if exists
  file:
    path: "{{workspace}}/tmp"
    state: absent
  when: stat_result.stat.exists

- name: remove the {{s3_folder}} if exists
  file:
    path: "{{workspace}}/{{s3_folder}}"
    state: absent
  when: stat_result.stat.exists

- name: update settings
  template:
    dest: "{{workspace}}/config/config.yml"
    src: "{{workspace}}/config/config.yml.j2"

- name: install python3
  yum:
    name: python3
    state: installed

- name: pip install requirements
  pip:
    requirements: "{{workspace}}/requirements.txt"
    executable: pip3


- name: loader data
  shell:
    cmd: >
      python3
      loader.py 
      {{workspace}}/config/config.yml
    chdir: "{{workspace}}"
  register: data_loader

- name: show dataloader output
  debug:
    msg: "{{data_loader}}"


############################################################################################################################

#     Restart the backend container to reload schema

############################################################################################################################

- name: query backend service
  ecs_service_info:
    cluster: bento-{{ tier }}
    service: bento-{{ tier }}-backend
    details: true
    region: "{{ region }}"
  register: service_backend

############################################################################################################################

- name: set backend facts
  set_fact:
    backend_task_definition: "{{ service_backend.services[0].taskDefinition }}"
    lb_backend: "{{ service_backend.services[0].loadBalancers }}"
    role_arn: "{{ service_backend.services[0].roleArn }}"

############################################################################################################################

- name: recreate backend service
  ecs_service:
    state: present
    name: bento-{{ tier }}-backend
    cluster: bento-{{ tier }}
    task_definition: "{{ backend_task_definition }}"
    role: "{{ role_arn }}"
    force_new_deployment: yes
    deployment_configuration:
      minimum_healthy_percent: 0
      maximum_percent: 100
    desired_count: 1
    load_balancers: "{{ lb_backend }}"
    region: "{{ region }}"
  register: service_backend_output
