---
- name: show project
  debug:
    msg: "{{project}}{{s3_folder}}{{wipe_db}}{{cheat_mode}}"

- name: set model files location for ctdc
  set_fact:
    model_file1: "{{workspace}}/ctdc-model/model-desc/ctdc_model_file.yaml"
    model_file2: "{{workspace}}/ctdc-model/model-desc/ctdc_model_properties_file.yaml"
    property_file: "config/props-ctdc.yml"

- name: Check if tmp directory exist
  stat:
    path: "{{workspace}}/tmp"
  register: stat_result

- name: Check if tmp {{s3_folder}} exist
  stat:
    path: "{{workspace}}/{{s3_folder}}"
  register: s3folder_result

- name: remove the tmp if exists
  file:
    path: "{{workspace}}/tmp"
    state: absent
  when: stat_result.stat.exists

- name: copy config.sample.ini config.ini
  copy:
    remote_src: yes
    src: "{{workspace}}/config/config.example.ini"
    dest: "{{workspace}}/config/config.ini"

- name: execute dataloader script
  shell:
    cmd: >
      /usr/bin/python3
      loader.py -i bolt://{{ neo4j_ip }}:7687 
      --config-file config/config.ini
      --prop-file {{ property_file }}
      -p {{ neo4j_password }}
      -s {{ model_file1 }}
      -s {{ model_file2 }}
      -c -b {{ data_bucket }}
      -f {{ s3_folder }} tmp
    chdir: "{{workspace}}"
  register: data_loader
  when: wipe_db == "no"

- name: show dataloader output
  debug:
    msg: "{{data_loader}}"

- name: wipe out database then execute dataloader script
  shell:
    cmd: >
      /usr/bin/python3
      loader.py -i bolt://{{ neo4j_ip }}:7687 
      --config-file config/config.ini
      --prop-file {{ property_file }}
      -p {{ neo4j_password }}
      -s {{ model_file1 }}
      -s {{ model_file2 }}
      -c -b {{ data_bucket }}
      -f {{ s3_folder }} tmp
      --wipe-db
      --yes
    chdir: "{{workspace}}"
  register: data_loader
  when: wipe_db == "yes"

- name: show dataloader output
  debug:
    msg: "{{data_loader}}"

