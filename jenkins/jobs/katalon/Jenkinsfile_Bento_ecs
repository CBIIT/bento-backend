//node('cicd_microservice') {
//	parameters {
//		extendedChoice( 
//			name: 'Browser', 
//			defaultValue: 'Firefox', 
//			description: 'Choose the browser (headless) to use', 
//			type: 'PT_SINGLE_SELECT',
//			value: 'Chrome,Firefox' )
//		}
//	stage('set agent'){
//		if (params.Browser == 'Firefox') {
//			AGENT_LABEL = "docker-katalon-ff"
//			} else {
//				AGENT_LABEL = "docker-katalon-ch"
//				}
//		}
//	}

pipeline {
	agent {
        node {
            //label "${AGENT_LABEL}"
			label "docker-katalon-ch"
            }
        }
	environment { 
        katalonVer = '7.2.6'
		chromedriverVer = '83.0.4103.39'
		geckodriverVer = '0.26.0'
		}
    parameters {

    gitParameter(branchFilter: 'origin/(.*)', 
        defaultValue: 'master', 
        name: 'Tag', 
        type: 'PT_BRANCH_TAG',
        quickFilterEnabled: false, 
        selectedValue: 'DEFAULT', 
        sortMode: 'ASCENDING_SMART', 
        tagFilter: '*', 
        useRepository: 'https://github.com/CBIIT/Commons_Automation')

    string(defaultValue: "Commons_Automation.prj", 
        description: 'Enter the Katalon Project file (include the path relative to the repo root):', 
        name: 'KatalonPrj')

    string(defaultValue: "Test Suites/Bento_Smoke", 
        description: 'Enter the Katalon Suite Path (not including the test suite file):', 
        name: 'KatalonSuite')

    extendedChoice( 
        name: 'Browser', 
        defaultValue: 'Chrome', 
        description: 'Choose the browser (headless) to use', 
        type: 'PT_SINGLE_SELECT',
        value: 'Chrome,Firefox' )
		
	extendedChoice( 
        name: 'Profile', 
        defaultValue: 'PERF_PROD', 
        description: 'Choose the profile to use', 
        type: 'PT_SINGLE_SELECT',
        value: 'PERF_PROD' )

	string(defaultValue: "michael.fleming@nih.gov", 
        description: 'Enter a list of email addresses to notify in case of test failures:', 
        name: 'EmailRecipients')

        }
    // options {
    // 	ansiColor('xterm')
    // }
    tools {
        jdk 'Default' 
        }
    stages{
        stage('checkout'){
            steps {

                checkout([$class: 'GitSCM', 
                    branches: [[name: "${params.Tag}"]], 
                    doGenerateSubmoduleConfigurations: false,
					extensions: [],
					submoduleCfg: [], 
                    userRemoteConfigs: [[url: 'https://github.com/CBIIT/Commons_Automation']]])

                }
            }
		stage('set Profile'){
		    environment {
                KATALON_PRJ         =   "${params.KatalonPrj}"
                }
			steps {
                script {
                    switch("${params.Profile}") {
                    case "QA_PROD":
						WIKI_PAGE="442632045"
						PROJECT="Bento"
						TIER="QA"
						withCredentials([string(credentialsId: 'Box_Email_QA_BENTO', variable: 'box_email'),
						  string(credentialsId: 'Box_Url_QA_BENTO', variable: 'box_url'),
					      file(credentialsId: 'Katalon_QA_PROD', variable: 'pass_file')]) {
                            BOX_EMAIL="${box_email}"
							BOX_URL="${box_url}"
							PROFILE="${pass_file}"
							sh "cp ${pass_file} ${WORKSPACE}/Profiles/"
                            }
                        break
					case "PERF_PROD":
						WIKI_PAGE="442632045"
						PROJECT="Bento"
						TIER="Perf"
						withCredentials([string(credentialsId: 'Box_Email_PERF_BENTO', variable: 'box_email'),
						  string(credentialsId: 'Box_Url_PERF_BENTO', variable: 'box_url'),
						  file(credentialsId: 'Katalon_PERF_PROD', variable: 'pass_file')]) {
                            BOX_EMAIL="${box_email}"
							BOX_URL="${box_url}"
							PROFILE="${pass_file}"
							sh "cp ${pass_file} ${WORKSPACE}/Profiles/"
                            }
                        break
					case "BENTO_ICDC":
						WIKI_PAGE="442632045"
						PROJECT="Bento"
						TIER="ICDC"
						withCredentials([string(credentialsId: 'Box_Email_BENTO_ICDC', variable: 'box_email'),
						  string(credentialsId: 'Box_Url_BENTO_ICDC', variable: 'box_url'),
						  file(credentialsId: 'Katalon_ICDC_PROD', variable: 'pass_file')]) {
                            BOX_EMAIL="${box_email}"
							BOX_URL="${box_url}"
							PROFILE="${pass_file}"
							sh "cp ${pass_file} ${WORKSPACE}/Profiles/"
                            }
                        break
                       }
                    }
				}
			}
		stage('run tests'){
            environment {
				KATALON_BROWSER     =   "${params.Browser}"
				KATALON_PROFILE     =   "${params.Profile}"
                KATALON_PRJ         =   "${params.KatalonPrj}"
                KATALON_SUITE_PATH  =   "${params.KatalonSuite}"
				PROFILE_FILE        =   "${PROFILE}"
                }
            steps {

				script {
						withCredentials([string(credentialsId: 'Katalon_API_Key', variable: 'api_key'),
						    string(credentialsId: 'Katalon_Org_ID', variable: 'org_id')]) {

							sh label: 'Katalon-Tests', script: '''#!/bin/bash
								
								# Set datestamp for results file
								dateStamp=$(date +%Y%m%d)
								reportFile="${KATALON_PROFILE}_${dateStamp}_build_${BUILD_NUMBER}"

								# Recreate the results directory
								rm -rf results && mkdir results
								
								# Create the output files directory (required for writing excel files)
								rm -rf OutputFiles && mkdir OutputFiles
								
								# Update profile filename
								profile_file=$(basename $PROFILE_FILE)
								profile_name="${profile_file%.*}"
								
								#echo "projectPath=$WORKSPACE/$KATALON_PRJ testSuitePath=$KATALON_SUITE_PATH executionProfile=$profile_name filename=$profile_file"
								
								# Run Katalon Tests
								katalonc -noSplash -runMode=console --config -webui.autoUpdateDrivers=true -projectPath="$WORKSPACE/$KATALON_PRJ" -retry=0 -testSuitePath="$KATALON_SUITE_PATH" -executionProfile="$profile_name" -browserType="$KATALON_BROWSER (headless)" -reportFolder="results" -reportFileName="$reportFile" -apiKey="$api_key" -orgID="$org_id"

								'''

							}
						}

                }
            }
        }
		post {
			always {

				script {

					sh label: 'Zip-Katalon-Results', script: '''#!/bin/bash

					apt-get update && apt-get install -y zip
					
					resultsFile=$(basename results/*.html)
					zipFile=$(basename -s .html results/*.html)
					
					zip -r results/$zipFile.zip OutputFiles
					zip -u results/$zipFile.zip results/$resultsFile

					'''

				}
				script {
				
				    ERROR_OUTPUT = sh (label: 'Katalon-Results-Parsing', script: '''#!/bin/bash
				
					project=''' + PROJECT + '''
					tier=''' + TIER + '''
					inputFile=$(exec find $WORKSPACE/results -type f -name "*.xml")

					# Get test stats
					totalTestCases="$(grep -c '<testcase' $inputFile)"
					passedTestCases="$(grep '<testcase' $inputFile | grep -c 'PASSED')"
					failedTestCases="$(grep '<testcase' $inputFile | grep -c 'FAILED')"
					errorTestCases="$(grep '<testcase' $inputFile | grep -c 'ERROR')"
				
					# function to read output file: JUnit.xml
					parse_results_xml(){
						error_message="Katalon Test results for the latest run on $project $tier (browser tested: $Browser): \\n\\n Total Tests Cases:     $totalTestCases \\n Passed Test Cases:     $passedTestCases \\n Failed Test Cases:     $failedTestCases \\n Errored Test Cases:    $errorTestCases \\n\\n"

						IFS=$'\\n'
						for line in $(grep '<testcase' $inputFile)
						do
						  if [[ "$line" =~ .*"FAILED" || "$line" =~ .*"ERROR" ]]
					      then
							  error_message+="$(echo $line | cut -d '=' -f 2 | cut -d '"' -f 2) \\n "
						  fi
						done
						}
				
						# Get test failures
						parse_results_xml
												
						error_message="\'$error_message\'"
						echo $error_message
				
                      ''',
						returnStdout: true).trim()
				
                    }

				script {
					EMAIL_BODY = sh (label: 'Get-Email-Body', script: '''#!/bin/bash

					emailBody=''' + ERROR_OUTPUT + '''
					boxUrl=''' + BOX_URL + '''
					resultsFile=$(basename results/*.zip)
					emailBody="<b> $emailBody"
					emailBody=${emailBody/\\\\n\\\\n/</b><br><br>}
					emailBody=${emailBody//\\\\n/<br>}
					emailBody="$emailBody <br><br><br> The results of this test run can be found in Box:  <a href=\\\"$boxUrl\\\">$resultsFile</a>"
					echo $emailBody

					''',
					returnStdout: true).trim()

					}

				emailext(attachmentsPattern: 'results/*.zip',
					mimeType: 'text/html',
					body: "${EMAIL_BODY}",
					subject: 'Katalon Tests: results attached',
					to: "${EmailRecipients}")
					
				
				}
			
			}
	}